class Calendar{constructor(t,e={}){if(this.root="string"==typeof t?document.querySelector(t):t,!this.root)throw new Error("Root element not found");this.opts=Object.assign({style:"dark",view:"year",minDate:null,monthsPerRow:3,startWeekOnMonday:!1,showHeader:!0,showArrows:!0,showYearInput:!0,displayYear:null},e),this.events=Object.assign({},this.opts.events||{}),this.wrapper=this.root.closest(".calendar-wrapper")||this.root.parentElement,this.wrapper||(this.wrapper=document.body),this._applyStyle(),this.opts.showHeader&&this._ensureHeader(),this.yearDisplay=this.wrapper.querySelector(".year-display"),this.prevBtn=this.wrapper.querySelector("#prevYear"),this.nextBtn=this.wrapper.querySelector("#nextYear"),this.dateInput=this.wrapper.querySelector("#dateInput"),this.today=new Date,this.currentYear="number"==typeof this.opts.displayYear&&Number.isInteger(this.opts.displayYear)?this.opts.displayYear:this.today.getFullYear(),this.view=this.opts.view||"year","number"==typeof this.opts.displayYear?this.currentDate=new Date(this.opts.displayYear,0,1):this.currentDate=new Date(this.today.getFullYear(),this.today.getMonth(),this.today.getDate()),this.opts.minDate instanceof Date?this.minDate=this._stripTime(this.opts.minDate):this.minDate=null,this.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],this.weekdayShort=this.opts.startWeekOnMonday?["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],this._bindControls(),this._ensureTooltip(),this._firstRender=!0,this.render()}_applyStyle(){this.wrapper&&("light"===this.opts.style?this.wrapper.classList.add("light"):this.wrapper.classList.remove("light"))}_bindControls(){this.prevBtn&&this.opts.showArrows&&this.prevBtn.addEventListener("click",(()=>this.prev())),this.nextBtn&&this.opts.showArrows&&this.nextBtn.addEventListener("click",(()=>this.next())),this.dateInput&&this.opts.showYearInput&&this.dateInput.addEventListener("change",(()=>{const t=this.dateInput.value;if(!t)return;const e=t.split("-").map((t=>parseInt(t,10)));if(3!==e.length)return;const n=new Date(e[0],e[1]-1,e[2]);this.currentDate=n,this.view="day",this.viewSelect&&(this.viewSelect.value="day"),this.render()})),this.viewSelect=this.wrapper.querySelector("#viewSelect"),this.viewSelect&&(this.viewSelect.value=this.view,this.viewSelect.addEventListener("change",(()=>{this.view=this.viewSelect.value,"month"===this.view&&(this.currentDate=this.currentDate||new Date(this.currentYear,0,1)),"day"===this.view&&(this.currentDate=this.currentDate||new Date),this.render()})))}prev(){if("month"===this.view){const t=this.currentDate||new Date(this.currentYear,0,1);this.currentDate=new Date(t.getFullYear(),t.getMonth()-1,1),this.render()}else if("day"===this.view){const t=this.currentDate||new Date;this.currentDate=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1),this.render()}else this.currentYear--,this.currentDate&&this.currentDate.setFullYear(this.currentYear),this.render()}next(){if("month"===this.view){const t=this.currentDate||new Date(this.currentYear,0,1);this.currentDate=new Date(t.getFullYear(),t.getMonth()+1,1),this.render()}else if("day"===this.view){const t=this.currentDate||new Date;this.currentDate=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1),this.render()}else this.currentYear++,this.currentDate&&this.currentDate.setFullYear(this.currentYear),this.render()}_transitionRender(t){this._firstRender?(this._firstRender=!1,t.call(this)):(this.root.style.transition="opacity 180ms ease",this.root.style.opacity="0",setTimeout((()=>{t.call(this),this.root.style.opacity="1"}),180))}_ensureHeader(){let t=this.wrapper.querySelector(".calendar-header");if(!t){t=document.createElement("div"),t.className="calendar-header";const e=document.createElement("div");e.className="year-display",e.textContent="Year";const n=document.createElement("div");n.className="controls";const s=document.createElement("button");s.className="btn",s.id="prevYear",s.textContent="◀";const r=document.createElement("input");r.className="btn",r.id="dateInput",r.type="date",r.style.width="160px",r.style.textAlign="center";const a=document.createElement("button");a.className="btn",a.id="nextYear",a.textContent="▶";const i=document.createElement("select");i.id="viewSelect",i.className="btn",i.innerHTML='<option value="year">Year</option><option value="month">Month</option><option value="day">Day</option>',this.opts.view&&(i.value=this.opts.view),n.appendChild(i),this.opts.showArrows&&n.appendChild(s),this.opts.showYearInput&&n.appendChild(r),this.opts.showArrows&&n.appendChild(a),t.appendChild(e),t.appendChild(n),this.wrapper.insertBefore(t,this.root)}}_stripTime(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}render(){this._transitionRender((function(){switch(this.view){case"month":this.renderMonth();break;case"day":this.renderDay();break;default:this.renderYear()}}))}renderYear(){this.root.innerHTML="",this.yearDisplay&&(this.yearDisplay.textContent=String(this.currentYear)),this.yearInput&&(this.yearInput.value=String(this.currentYear)),this.dateInput&&(this.dateInput.value=this._formatDate(new Date(this.currentYear,0,1)));const t=document.createElement("div");t.className="year-grid",t.style.gridTemplateColumns=`repeat(${this.opts.monthsPerRow}, 1fr)`;for(let e=0;e<12;e++){const n=document.createElement("div");n.className="month";const s=document.createElement("div");s.className="month-title";const r=document.createElement("h3");r.textContent=this.monthNames[e];const a=document.createElement("small");a.className="muted",a.textContent=`${this.currentYear}`,s.appendChild(r),s.appendChild(a);const i=document.createElement("div");i.className="weekdays",this.weekdayShort.forEach((t=>{const e=document.createElement("div");e.textContent=t,i.appendChild(e)}));const o=document.createElement("div");o.className="days";let l=new Date(this.currentYear,e,1).getDay();this.opts.startWeekOnMonday&&(l=(l+6)%7);const h=new Date(this.currentYear,e+1,0).getDate();for(let t=0;t<l;t++){const t=document.createElement("div");t.className="day",t.setAttribute("aria-disabled","true"),o.appendChild(t)}for(let t=1;t<=h;t++){const n=document.createElement("button");n.className="day",n.type="button",n.textContent=String(t),n.dataset.date=`${this.currentYear}-${String(e+1).padStart(2,"0")}-${String(t).padStart(2,"0")}`;if(this.currentYear===this.today.getFullYear()&&e===this.today.getMonth()&&t===this.today.getDate()&&n.classList.add("today"),this.minDate){new Date(this.currentYear,e,t)<this.minDate&&(n.setAttribute("aria-disabled","true"),n.disabled=!0)}n.addEventListener("click",(t=>this._onDayClick(t,n))),n.addEventListener("keydown",(t=>{"Enter"!==t.key&&" "!==t.key||this._onDayClick(t,n)}));const s=this.events[n.dataset.date];let r=[];if(s&&(r=Array.isArray(s)?s.slice():[s]),r.length>0)if(n.title=r.map((t=>t&&t.text?t.text:"")).filter(Boolean).join(" | ")||n.title,1===r.length)n.style.background=r[0].color||"var(--accent)",n.style.color=r[0].color?this._contrastColor(r[0].color):"";else{const t=100/r.length,e=r.map(((e,n)=>{const s=Math.round(n*t),r=Math.round((n+1)*t);return`${e.color||"var(--accent)"} ${s}% ${r}%`}));n.style.background=`linear-gradient(90deg, ${e.join(", ")})`,n.style.color=""}else n.title="",n.style.background="",n.style.color="";o.appendChild(n)}n.appendChild(s),n.appendChild(i),n.appendChild(o),t.appendChild(n)}this.root.appendChild(t)}renderMonth(){this.root.innerHTML="";const t=this.currentDate.getFullYear(),e=this.currentDate.getMonth();this.yearDisplay&&(this.yearDisplay.textContent=`${this.monthNames[e]} ${t}`),this.dateInput&&(this.dateInput.value=this._formatDate(new Date(t,e,1)));const n=document.createElement("div");n.className="month single-month";const s=document.createElement("div");s.className="month-title";const r=document.createElement("h3");r.textContent=this.monthNames[e];const a=document.createElement("small");a.className="muted",a.textContent=`${t}`,s.appendChild(r),s.appendChild(a);const i=document.createElement("div");i.className="weekdays",this.weekdayShort.forEach((t=>{const e=document.createElement("div");e.textContent=t,i.appendChild(e)}));const o=document.createElement("div");o.className="days";let l=new Date(t,e,1).getDay();this.opts.startWeekOnMonday&&(l=(l+6)%7);const h=new Date(t,e+1,0).getDate();for(let t=0;t<l;t++){const t=document.createElement("div");t.className="day",t.setAttribute("aria-disabled","true"),o.appendChild(t)}for(let n=1;n<=h;n++){const s=document.createElement("button");s.className="day",s.type="button",s.textContent=String(n),s.dataset.date=`${t}-${String(e+1).padStart(2,"0")}-${String(n).padStart(2,"0")}`;if(t===this.today.getFullYear()&&e===this.today.getMonth()&&n===this.today.getDate()&&s.classList.add("today"),this.minDate){new Date(t,e,n)<this.minDate&&(s.setAttribute("aria-disabled","true"),s.disabled=!0)}s.addEventListener("click",(r=>{this._onDayClick(r,s),r.shiftKey&&(this.currentDate=new Date(t,e,n),this.view="day",this.render())})),s.addEventListener("keydown",(r=>{"Enter"!==r.key&&" "!==r.key||(r.preventDefault(),this._onDayClick(r,s),r.shiftKey&&(this.currentDate=new Date(t,e,n),this.view="day",this.render()))}));const r=this.events[s.dataset.date];let a=[];if(r&&(a=Array.isArray(r)?r.slice():[r]),a.length>0)if(s.title=a.map((t=>t&&t.text?t.text:"")).filter(Boolean).join(" | ")||s.title,1===a.length)s.style.background=a[0].color||"var(--accent)",s.style.color=a[0].color?this._contrastColor(a[0].color):"";else{const t=100/a.length,e=a.map(((e,n)=>{const s=Math.round(n*t),r=Math.round((n+1)*t);return`${e.color||"var(--accent)"} ${s}% ${r}%`}));s.style.background=`linear-gradient(90deg, ${e.join(", ")})`,s.style.color=""}o.appendChild(s)}n.appendChild(s),n.appendChild(i),n.appendChild(o),this.root.appendChild(n)}renderDay(){this.root.innerHTML="";const t=this.currentDate.getFullYear(),e=this.currentDate.getMonth(),n=this.currentDate.getDate();this.yearDisplay&&(this.yearDisplay.textContent=`${this.monthNames[e]} ${n}, ${t}`),this.dateInput&&(this.dateInput.value=this._formatDate(this.currentDate));const s=document.createElement("div");s.className="day-panel";const r=`${t}-${String(e+1).padStart(2,"0")}-${String(n).padStart(2,"0")}`,a=this.events[r];if(!a||Array.isArray(a)&&0===a.length){const t=document.createElement("p");t.className="muted",t.textContent="No events for this date.",s.appendChild(t)}else{document.createElement("div").className="event-list";(Array.isArray(a)?a:[a]).forEach(((t,e)=>{const n=document.createElement("div");n.className="event-item",n.textContent=t&&t.text?t.text:`Event ${e+1}`,n.style.background=t&&t.color?t.color:"",n.style.color=t&&t.color?this._contrastColor(t.color):"",s.appendChild(n)}))}this.root.appendChild(s)}_ensureTooltip(){this.tooltipEl||(this.tooltipEl=document.createElement("div"),this.tooltipEl.className="date-tooltip",this.tooltipEl.style.display="none",document.body.appendChild(this.tooltipEl))}_onDayClick(t,e){if(this._ensureTooltip(),e.disabled)return;const n=e.dataset.date,s=this.events[n];let r=[];s&&(r=Array.isArray(s)?s.slice():[s]);let a=`<strong>${n}</strong>`;r.length>0?(a+='<div style="margin-top:8px">',r.forEach((t=>{const e=t&&t.color?t.color:"transparent",n=t&&t.text?t.text:"";a+=`<div style="display:flex;align-items:center;gap:8px;margin-top:6px">\n\t\t\t\t\t<span style="width:12px;height:12px;display:inline-block;border-radius:2px;background:${e};border:1px solid rgba(0,0,0,0.08)"></span>\n\t\t\t\t\t<span style="color:var(--muted)">${n}</span>\n\t\t\t\t</div>`})),a+="</div>"):a+='<div style="margin-top:6px;color:var(--muted)">No events for this date.</div>',a+='<div style="margin-top:8px;color:var(--muted)">Click outside to close</div>',this.tooltipEl.innerHTML=a,this.tooltipEl.style.display="block";const i=e.getBoundingClientRect(),o=this.tooltipEl.offsetWidth||200,l=this.tooltipEl.offsetHeight||60,h=t&&"number"==typeof t.clientX?t.clientX:i.left+i.width/2,d=t&&"number"==typeof t.clientY?t.clientY:i.top+i.height/2;let c=Math.round(h-o/2);c=Math.max(8,Math.min(c,window.innerWidth-o-8));let p=Math.round(d-l-12);p<8&&(p=Math.round(d+12)),this.tooltipEl.style.left=c+"px",this.tooltipEl.style.top=p+"px";const u=t=>{this.tooltipEl.contains(t.target)||t.target===e||(this.tooltipEl.style.display="none",document.removeEventListener("click",u))};setTimeout((()=>document.addEventListener("click",u)),0)}nextYear(){this.currentYear++,this.render()}prevYear(){this.currentYear--,this.render()}setYear(t){this.currentYear=t,this.render()}addEvent(t,e){this.events[t]||(this.events[t]=[]),Array.isArray(this.events[t])||(this.events[t]=[this.events[t]]),this.events[t].push(e),this.render()}removeEvent(t,e=null){this.events[t]&&(null===e?delete this.events[t]:Array.isArray(this.events[t])&&(this.events[t].splice(e,1),0===this.events[t].length&&delete this.events[t]),this.render())}getEvent(t){return this.events[t]||null}_formatDate(t){if(!(t instanceof Date))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}_contrastColor(t){if(!t)return"";let e=t.replace("#","");3===e.length&&(e=e.split("").map((t=>t+t)).join(""));return(.2126*parseInt(e.substr(0,2),16)+.7152*parseInt(e.substr(2,2),16)+.0722*parseInt(e.substr(4,2),16))/255>.6?"#0b1220":"#ffffff"}}window.Calendar=Calendar;try{document.addEventListener("DOMContentLoaded",(()=>{const t=window.__YEAR_VIEW_CALENDAR_OPTS&&"object"==typeof window.__YEAR_VIEW_CALENDAR_OPTS?window.__YEAR_VIEW_CALENDAR_OPTS:{};if(!1===t.autoInit)return;const e=document.querySelector(".calendar");if(!e)return;if(e.__calendarInstance)return;const n=Object.assign({style:"light",minDate:null,monthsPerRow:3,startWeekOnMonday:!1,events:t.events||{},showHeader:!0,showArrows:!0,showYearInput:!0,displayYear:(new Date).getFullYear()},t);e.__calendarInstance=new Calendar(e,n),window.myCalendar=e.__calendarInstance}))}catch(t){console.error("Auto-init error in year-view-calendar:",t)}